name: iOS Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
      
      - name: Install Flutter dependencies
        run: |
          cd frontend
          flutter pub get
          flutter precache --ios
      
      - name: Generate Flutter configuration files
        run: |
          cd frontend
          # Создаём Generated.xcconfig вручную с правильными путями
          FLUTTER_ROOT=$(dirname $(dirname $(which flutter)))
          mkdir -p ios/Flutter
          {
            echo "// This is a generated file; do not edit or check into version control."
            echo "FLUTTER_ROOT=$FLUTTER_ROOT"
            echo "FLUTTER_APPLICATION_PATH=\$(SRCROOT)/.."
            echo "COCOAPODS_PARALLEL_CODE_SIGN=true"
            echo "FLUTTER_TARGET=lib/main.dart"
            echo "FLUTTER_BUILD_DIR=build"
            echo "FLUTTER_BUILD_NAME=1.0.0"
            echo "FLUTTER_BUILD_NUMBER=1"
            echo "EXCLUDED_ARCHS[sdk=iphonesimulator*]=i386"
            echo "EXCLUDED_ARCHS[sdk=iphoneos*]=armv7"
            echo "DART_OBFUSCATION=false"
            echo "TRACK_WIDGET_CREATION=true"
            echo "TREE_SHAKE_ICONS=false"
            echo "PACKAGE_CONFIG=.dart_tool/package_config.json"
          } > ios/Flutter/Generated.xcconfig
          
          # Убеждаемся, что Debug.xcconfig и Release.xcconfig существуют
          [ -f "ios/Flutter/Debug.xcconfig" ] || echo '#include "Generated.xcconfig"' > ios/Flutter/Debug.xcconfig
          [ -f "ios/Flutter/Release.xcconfig" ] || echo '#include "Generated.xcconfig"' > ios/Flutter/Release.xcconfig
          echo "✓ Flutter config files ready"
      
      - name: Install CocoaPods dependencies
        run: |
          cd frontend/ios
          pod install --repo-update
          echo "✓ CocoaPods dependencies installed"
      
      - name: Build Debug first to generate Pods files
        run: |
          cd frontend/ios
          # Собираем Debug конфигурацию, чтобы CocoaPods создал все необходимые файлы
          xcodebuild clean build \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Debug \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build-debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            CODE_SIGN_STYLE=Manual 2>&1 | tail -50 || true
          
          # Копируем созданные файлы Pods для Release
          PODS_DIR="Pods/Target Support Files/Pods-Runner"
          if [ -f "${PODS_DIR}/Pods-Runner-frameworks-Debug-input-files.xcfilelist" ]; then
            cp "${PODS_DIR}/Pods-Runner-frameworks-Debug-input-files.xcfilelist" \
               "${PODS_DIR}/Pods-Runner-frameworks-Release-input-files.xcfilelist" 2>/dev/null || true
          fi
          if [ -f "${PODS_DIR}/Pods-Runner-frameworks-Debug-output-files.xcfilelist" ]; then
            cp "${PODS_DIR}/Pods-Runner-frameworks-Debug-output-files.xcfilelist" \
               "${PODS_DIR}/Pods-Runner-frameworks-Release-output-files.xcfilelist" 2>/dev/null || true
          fi
          
          # Создаём файлы, если их всё ещё нет
          mkdir -p "${PODS_DIR}"
          [ -f "${PODS_DIR}/Pods-Runner-frameworks-Release-input-files.xcfilelist" ] || echo "" > "${PODS_DIR}/Pods-Runner-frameworks-Release-input-files.xcfilelist"
          [ -f "${PODS_DIR}/Pods-Runner-frameworks-Release-output-files.xcfilelist" ] || echo "" > "${PODS_DIR}/Pods-Runner-frameworks-Release-output-files.xcfilelist"
          
          # Удаляем debug сборку
          rm -rf build-debug
          
          # Исправляем абсолютные пути во всех файлах CocoaPods
          python3 << 'PYTHON_SCRIPT'
          import re
          import os
          import glob
          
          # Исправляем пути в project.pbxproj
          project_file = 'Runner.xcodeproj/project.pbxproj'
          if os.path.exists(project_file):
              with open(project_file, 'r') as f:
                  content = f.read()
              
              # Заменяем абсолютные пути на относительные
              content = re.sub(
                  r"'/Target Support Files/([^']+)'",
                  r"'$(SRCROOT)/Pods/Target Support Files/\1'",
                  content
              )
              content = re.sub(
                  r'"/Target Support Files/([^"]+)"',
                  r'"$(SRCROOT)/Pods/Target Support Files/\1"',
                  content
              )
              
              with open(project_file, 'w') as f:
                  f.write(content)
              print("✓ Fixed paths in project.pbxproj")
          
          # Исправляем пути в скриптах CocoaPods
          script_files = glob.glob('Pods/Target Support Files/Pods-Runner/*.sh')
          for script_file in script_files:
              try:
                  with open(script_file, 'r') as f:
                      content = f.read()
                  original = content
                  content = re.sub(r"'/Target Support Files/", "'$(SRCROOT)/Pods/Target Support Files/", content)
                  content = re.sub(r'"/Target Support Files/', '"$(SRCROOT)/Pods/Target Support Files/', content)
                  if content != original:
                      with open(script_file, 'w') as f:
                          f.write(content)
                      print(f"✓ Fixed paths in {script_file}")
              except:
                  pass
          
          print("✓ All paths fixed")
          PYTHON_SCRIPT
          
          echo "✓ Pods files prepared for Release"
      
      - name: Build iOS app
        run: |
          cd frontend
          # Используем flutter build ios напрямую с отключённой подписью
          # Flutter сам вызовет xcodebuild с правильными параметрами
          flutter build ios --release --no-codesign \
            --build-args="--xcode-build-setting=CODE_SIGN_IDENTITY= --xcode-build-setting=CODE_SIGNING_REQUIRED=NO --xcode-build-setting=CODE_SIGNING_ALLOWED=NO --xcode-build-setting=DEVELOPMENT_TEAM=" || {
            echo "flutter build ios failed, trying xcodebuild directly..."
            cd ios
            xcodebuild clean build \
              -workspace Runner.xcworkspace \
              -scheme Runner \
              -configuration Release \
              -sdk iphoneos \
              -destination 'generic/platform=iOS' \
              -derivedDataPath build \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              DEVELOPMENT_TEAM="" \
              PROVISIONING_PROFILE_SPECIFIER="" \
              CODE_SIGN_STYLE=Manual
            # Копируем результат
            if [ -d "build/Build/Products/Release-iphoneos/Runner.app" ]; then
              mkdir -p ../build/ios/iphoneos
              cp -r build/Build/Products/Release-iphoneos/Runner.app ../build/ios/iphoneos/
            fi
          }
          
          # Проверяем результат
          if [ -d "build/ios/iphoneos/Runner.app" ]; then
            echo "✓ Build successful"
          else
            echo "✗ Build failed - Runner.app not found"
            exit 1
          fi
      
      - name: Create IPA
        run: |
          cd frontend/build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r Runner.ipa Payload
          mkdir -p ../ipa
          mv Runner.ipa ../ipa/
          echo "✓ IPA created"
          ls -lh ../ipa/
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: frontend/build/ios/ipa/*.ipa
          if-no-files-found: error
          retention-days: 30
