name: iOS Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
      
      - name: Install dependencies
        run: |
          cd frontend
          flutter pub get
          flutter precache --ios
      
      - name: Prepare Flutter environment
        run: |
          cd frontend
          # Используем flutter assemble для генерации файлов без полной сборки
          # Это создаст Generated.xcconfig
          flutter assemble -dTargetPlatform=ios -dTargetFile=lib/main.dart -dBuildMode=debug ios_framework_ios 2>&1 | head -20 || true
          # Если файл не создан, создаём его вручную
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "Creating Generated.xcconfig manually..."
            FLUTTER_ROOT=$(dirname $(dirname $(which flutter)))
            {
              echo "// This is a generated file; do not edit or check into version control."
              echo "FLUTTER_ROOT=$FLUTTER_ROOT"
              echo "FLUTTER_APPLICATION_PATH=\$(SRCROOT)/.."
              echo "COCOAPODS_PARALLEL_CODE_SIGN=true"
              echo "FLUTTER_TARGET=lib/main.dart"
              echo "FLUTTER_BUILD_DIR=build"
              echo "FLUTTER_BUILD_NAME=1.0.0"
              echo "FLUTTER_BUILD_NUMBER=1"
              echo "EXCLUDED_ARCHS[sdk=iphonesimulator*]=i386"
              echo "EXCLUDED_ARCHS[sdk=iphoneos*]=armv7"
              echo "DART_OBFUSCATION=false"
              echo "TRACK_WIDGET_CREATION=true"
              echo "TREE_SHAKE_ICONS=false"
              echo "PACKAGE_CONFIG=.dart_tool/package_config.json"
            } > ios/Flutter/Generated.xcconfig
          fi
          echo "✓ Generated.xcconfig ready"
          cat ios/Flutter/Generated.xcconfig
          # Убеждаемся, что Debug.xcconfig и Release.xcconfig существуют
          [ -f "ios/Flutter/Debug.xcconfig" ] || echo '#include "Generated.xcconfig"' > ios/Flutter/Debug.xcconfig
          [ -f "ios/Flutter/Release.xcconfig" ] || echo '#include "Generated.xcconfig"' > ios/Flutter/Release.xcconfig
          echo "✓ All xcconfig files ready"
          ls -la ios/Flutter/*.xcconfig
      
      - name: Install CocoaPods dependencies
        run: |
          cd frontend/ios
          # Запускаем pod install после создания конфигурационных файлов
          pod install --repo-update
          echo "✓ pod install completed"
          # Проверяем, что файлы Pods созданы
          if [ -d "Pods/Target Support Files/Pods-Runner" ]; then
            echo "✓ Pods files directory exists"
            ls -la "Pods/Target Support Files/Pods-Runner/" || true
          fi
      
      - name: Create missing Pods files for Debug and Release
        run: |
          cd frontend/ios
          PODS_DIR="Pods/Target Support Files/Pods-Runner"
          mkdir -p "${PODS_DIR}"
          
          # Создаём файлы для Debug конфигурации, если их нет
          if [ ! -f "${PODS_DIR}/Pods-Runner-frameworks-Debug-input-files.xcfilelist" ]; then
            echo "" > "${PODS_DIR}/Pods-Runner-frameworks-Debug-input-files.xcfilelist"
            echo "✓ Created Debug input files"
          fi
          if [ ! -f "${PODS_DIR}/Pods-Runner-frameworks-Debug-output-files.xcfilelist" ]; then
            echo "" > "${PODS_DIR}/Pods-Runner-frameworks-Debug-output-files.xcfilelist"
            echo "✓ Created Debug output files"
          fi
          
          # Создаём файлы для Release конфигурации
          if [ ! -f "${PODS_DIR}/Pods-Runner-frameworks-Release-input-files.xcfilelist" ]; then
            if [ -f "${PODS_DIR}/Pods-Runner-frameworks-Debug-input-files.xcfilelist" ]; then
              cp "${PODS_DIR}/Pods-Runner-frameworks-Debug-input-files.xcfilelist" \
                 "${PODS_DIR}/Pods-Runner-frameworks-Release-input-files.xcfilelist"
              echo "✓ Copied Debug input files to Release"
            else
              echo "" > "${PODS_DIR}/Pods-Runner-frameworks-Release-input-files.xcfilelist"
              echo "✓ Created empty Release input files"
            fi
          fi
          if [ ! -f "${PODS_DIR}/Pods-Runner-frameworks-Release-output-files.xcfilelist" ]; then
            if [ -f "${PODS_DIR}/Pods-Runner-frameworks-Debug-output-files.xcfilelist" ]; then
              cp "${PODS_DIR}/Pods-Runner-frameworks-Debug-output-files.xcfilelist" \
                 "${PODS_DIR}/Pods-Runner-frameworks-Release-output-files.xcfilelist"
              echo "✓ Copied Debug output files to Release"
            else
              echo "" > "${PODS_DIR}/Pods-Runner-frameworks-Release-output-files.xcfilelist"
              echo "✓ Created empty Release output files"
            fi
          fi
          
          # Проверяем все файлы
          echo "All Pods files:"
          ls -la "${PODS_DIR}/" || true
      
      - name: Verify Release.xcconfig exists
        run: |
          cd frontend/ios/Flutter
          if [ -f "Release.xcconfig" ]; then
            echo "✓ Release.xcconfig exists"
            cat Release.xcconfig
          else
            echo "✗ Release.xcconfig NOT found, creating..."
            echo '#include "Generated.xcconfig"' > Release.xcconfig
          fi
          # Проверяем Generated.xcconfig
          if [ -f "Generated.xcconfig" ]; then
            echo "✓ Generated.xcconfig exists"
          else
            echo "✗ Generated.xcconfig NOT found"
            exit 1
          fi
      
      - name: Clean debug build artifacts
        run: |
          cd frontend
          # Удаляем только артефакты сборки, оставляем конфигурационные файлы
          rm -rf build/ios/iphoneos build/ios/iphonesimulator
      
      - name: Build IPA
        id: build_ipa
        run: |
          cd frontend
          # Пробуем использовать flutter build ipa
          flutter build ipa --release --no-codesign || {
            echo "flutter build ipa failed, trying manual build"
            # Альтернативный способ: собираем через flutter build ios
            flutter build ios --release --no-codesign
            # Создаем IPA вручную
            cd build/ios/iphoneos
            mkdir -p Payload
            cp -r Runner.app Payload/
            zip -r Runner.ipa Payload
            mkdir -p ../ipa
            mv Runner.ipa ../ipa/
          }
      
      - name: Verify IPA exists
        run: |
          if [ -f "frontend/build/ios/ipa/Runner.ipa" ]; then
            echo "IPA found at frontend/build/ios/ipa/Runner.ipa"
            ls -lh frontend/build/ios/ipa/
          elif [ -f "frontend/build/ios/ipa/*.ipa" ]; then
            echo "IPA found with wildcard"
            ls -lh frontend/build/ios/ipa/
          else
            echo "IPA not found, listing build directory:"
            find frontend/build -name "*.ipa" -o -name "*.app" | head -20
            exit 1
          fi
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: |
            frontend/build/ios/ipa/*.ipa
            frontend/build/ios/iphoneos/*.ipa
          if-no-files-found: error
          retention-days: 30

