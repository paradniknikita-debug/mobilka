#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è .env —Ñ–∞–π–ª–∞ –∏–∑ —à–∞–±–ª–æ–Ω–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./create-env.sh

set -e

echo "========================================"
echo "–°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞"
echo "========================================"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —à–∞–±–ª–æ–Ω–∞
if [ ! -f ".env.production.example" ]; then
    echo "‚ùå –§–∞–π–ª .env.production.example –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ .env
if [ -f ".env" ]; then
    echo "‚ö†Ô∏è  –§–∞–π–ª .env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    read -p "–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "–û—Ç–º–µ–Ω–µ–Ω–æ."
        exit 0
    fi
    echo "–°–æ–∑–¥–∞—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é..."
    cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
fi

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
echo "[1/3] –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞..."
cp .env.production.example .env
echo "‚úÖ –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω –∏–∑ —à–∞–±–ª–æ–Ω–∞"
echo ""

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SECRET_KEY
echo "[2/3] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SECRET_KEY..."
if command -v python3 &> /dev/null; then
    SECRET_KEY=$(python3 -c "import secrets; print(secrets.token_urlsafe(32))")
    # –ó–∞–º–µ–Ω–∞ SECRET_KEY –≤ .env (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Linux/Mac)
    if [[ "$OSTYPE" == "darwin"* ]] || [[ "$OSTYPE" == "linux-gnu"* ]]; then
        sed -i.bak "s|SECRET_KEY=CHANGE_ME_GENERATE_SECRET_KEY|SECRET_KEY=$SECRET_KEY|" .env
        rm -f .env.bak
        echo "‚úÖ SECRET_KEY —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ .env"
    else
        echo "‚ö†Ô∏è  –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–º–µ–Ω–∞ SECRET_KEY –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º–µ"
        echo "   –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á: $SECRET_KEY"
        echo "   –í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ .env —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é"
    fi
else
    echo "‚ö†Ô∏è  Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–µ –º–æ–≥—É —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å SECRET_KEY"
    echo "   –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é: python3 -c \"import secrets; print(secrets.token_urlsafe(32))\""
fi
echo ""

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
echo "[3/3] –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é"
echo "========================================"
echo ""
echo "‚úÖ –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω!"
echo ""
echo "üìù –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è:"
echo ""
echo "   1. POSTGRES_PASSWORD - –ø—Ä–∏–¥—É–º–∞–π—Ç–µ —Å–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 16 —Å–∏–º–≤–æ–ª–æ–≤)"
echo "   2. DATABASE_URL - –∑–∞–º–µ–Ω–∏—Ç–µ CHANGE_ME_STRONG_PASSWORD_16_CHARS_MIN –Ω–∞ –≤–∞—à –ø–∞—Ä–æ–ª—å"
echo "   3. SECRET_KEY - —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω (–µ—Å–ª–∏ Python3 –¥–æ—Å—Ç—É–ø–µ–Ω)"
echo "   4. CORS_ORIGINS - —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –¥–æ–º–µ–Ω –∏–ª–∏ IP"
echo ""
echo "üìã –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
echo "   nano .env"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û:"
echo "   - –ù–ï –∫–æ–º–º–∏—Ç—å—Ç–µ .env –≤ Git!"
echo "   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏"
echo "   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º"
echo ""

