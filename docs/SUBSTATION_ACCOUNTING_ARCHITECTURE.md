# Архитектура системы учета подстанций и оборудования

## Концепция системы учета

Система учета подстанций и оборудования представляет собой ERP-подобный модуль для детального управления инфраструктурой подстанций с иерархической структурой объектов. Система обеспечивает полный учет оборудования от уровня подстанции до конкретных единиц оборудования в ячейках, что позволяет вести инвентаризацию, планировать обслуживание и отслеживать состояние оборудования.

## Иерархическая структура объектов

### Уровни иерархии

```
Подстанция (Substation)
  └── Распределительное устройство (Switchyard/Bay)
      └── Секция шин (Busbar Section)
          └── Ячейка (Bay/Cell)
              └── Оборудование (Equipment)
```

### Детальное описание уровней

**1. Подстанция (Substation)** - верхний уровень иерархии
- Основная информация: название, код, тип (ТП, КТП, МТП, РП), напряжение, адрес, координаты
- Связь с географическими регионами и филиалами
- Статус активности
- Связь с ЛЭП через подключения (Connection)

**2. Распределительное устройство (Switchyard/Bay)** - средний уровень
- Название РУ (например, "РУ-10 кВ", "РУ-0.4 кВ")
- Тип РУ (открытое, закрытое, КРУ, КРУН)
- Номинальное напряжение
- Количество секций шин
- Описание и характеристики

**3. Секция шин (Busbar Section)** - уровень организации шин
- Название секции (например, "Секция I", "Секция II")
- Тип секционирования
- Номинальный ток
- Связь с другими секциями через секционные выключатели

**4. Ячейка (Bay/Cell)** - уровень ячеек
- Номер ячейки
- Назначение ячейки (ввод, отходящая линия, секционный выключатель, трансформатор)
- Номинальный ток
- Тип ячейки (одноцепная, двухцепная)
- Связь с секцией шин

**5. Оборудование (Equipment)** - нижний уровень
- Тип оборудования (трансформатор, выключатель, разъединитель, защита, измерительное)
- Производитель, модель, серийный номер
- Технические характеристики (мощность, ток, напряжение)
- Даты установки, последнего и следующего обслуживания
- Статус (активен, на обслуживании, выведен из эксплуатации)

## Модели данных (Backend)

### Модель Switchyard (Распределительное устройство)

```python
class Switchyard(Base):
    __tablename__ = "switchyards"
    
    id = Column(Integer, primary_key=True, index=True)
    mrid = Column(String(36), unique=True, index=True, nullable=False, default=generate_mrid)
    substation_id = Column(Integer, ForeignKey("substations.id"), nullable=False)
    name = Column(String(100), nullable=False)
    code = Column(String(20), nullable=False)
    switchyard_type = Column(String(50), nullable=False)  # открытое, закрытое, КРУ, КРУН
    voltage_level = Column(Float, nullable=False)  # кВ
    description = Column(Text, nullable=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    
    # Связи
    substation = relationship("Substation", back_populates="switchyards")
    busbar_sections = relationship("BusbarSection", back_populates="switchyard", cascade="all, delete-orphan")
```

### Модель BusbarSection (Секция шин)

```python
class BusbarSection(Base):
    __tablename__ = "busbar_sections"
    
    id = Column(Integer, primary_key=True, index=True)
    mrid = Column(String(36), unique=True, index=True, nullable=False, default=generate_mrid)
    switchyard_id = Column(Integer, ForeignKey("switchyards.id"), nullable=False)
    name = Column(String(100), nullable=False)
    section_number = Column(Integer, nullable=False)  # Номер секции (I, II, III)
    nominal_current = Column(Float, nullable=True)  # А
    description = Column(Text, nullable=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    
    # Связи
    switchyard = relationship("Switchyard", back_populates="busbar_sections")
    bays = relationship("Bay", back_populates="busbar_section", cascade="all, delete-orphan")
```

### Модель Bay (Ячейка)

```python
class Bay(Base):
    __tablename__ = "bays"
    
    id = Column(Integer, primary_key=True, index=True)
    mrid = Column(String(36), unique=True, index=True, nullable=False, default=generate_mrid)
    busbar_section_id = Column(Integer, ForeignKey("busbar_sections.id"), nullable=False)
    bay_number = Column(String(20), nullable=False)  # Номер ячейки
    bay_type = Column(String(50), nullable=False)  # ввод, отходящая линия, секционный, трансформатор
    nominal_current = Column(Float, nullable=True)  # А
    description = Column(Text, nullable=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    
    # Связи
    busbar_section = relationship("BusbarSection", back_populates="bays")
    equipment = relationship("SubstationEquipment", back_populates="bay", cascade="all, delete-orphan")
```

### Модель SubstationEquipment (Оборудование подстанции)

```python
class SubstationEquipment(Base):
    __tablename__ = "substation_equipment"
    
    id = Column(Integer, primary_key=True, index=True)
    mrid = Column(String(36), unique=True, index=True, nullable=False, default=generate_mrid)
    bay_id = Column(Integer, ForeignKey("bays.id"), nullable=False)
    equipment_type = Column(String(50), nullable=False)  # трансформатор, выключатель, разъединитель, защита, измерительное
    name = Column(String(100), nullable=False)
    manufacturer = Column(String(100), nullable=True)
    model = Column(String(100), nullable=True)
    serial_number = Column(String(100), nullable=True)
    
    # Технические характеристики (JSON для гибкости)
    specifications = Column(JSON, nullable=True)  # мощность, ток, напряжение и т.д.
    
    # Даты обслуживания
    installation_date = Column(DateTime, nullable=True)
    last_maintenance_date = Column(DateTime, nullable=True)
    next_maintenance_date = Column(DateTime, nullable=True)
    
    # Статус
    status = Column(String(20), default="active")  # active, maintenance, decommissioned
    
    notes = Column(Text, nullable=True)
    created_by = Column(Integer, ForeignKey("users.id"), nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    
    # Связи
    bay = relationship("Bay", back_populates="equipment")
    creator = relationship("User")
```

### Обновление модели Substation

```python
class Substation(Base):
    # ... существующие поля ...
    
    # Новые связи
    switchyards = relationship("Switchyard", back_populates="substation", cascade="all, delete-orphan")
```

## API Endpoints

### Подстанции

```
GET    /api/v1/substations                    # Список подстанций с фильтрацией
GET    /api/v1/substations/{id}               # Детальная информация о подстанции
GET    /api/v1/substations/{id}/structure     # Полная иерархическая структура
POST   /api/v1/substations                    # Создание подстанции
PUT    /api/v1/substations/{id}               # Обновление подстанции
DELETE /api/v1/substations/{id}               # Удаление подстанции
```

### Распределительные устройства

```
GET    /api/v1/substations/{id}/switchyards           # Список РУ подстанции
GET    /api/v1/substations/{id}/switchyards/{sw_id}    # Детали РУ
POST   /api/v1/substations/{id}/switchyards           # Создание РУ
PUT    /api/v1/substations/{id}/switchyards/{sw_id}    # Обновление РУ
DELETE /api/v1/substations/{id}/switchyards/{sw_id}   # Удаление РУ
```

### Секции шин

```
GET    /api/v1/switchyards/{sw_id}/busbar-sections     # Список секций
POST   /api/v1/switchyards/{sw_id}/busbar-sections     # Создание секции
PUT    /api/v1/busbar-sections/{bs_id}                 # Обновление секции
DELETE /api/v1/busbar-sections/{bs_id}                 # Удаление секции
```

### Ячейки

```
GET    /api/v1/busbar-sections/{bs_id}/bays            # Список ячеек
POST   /api/v1/busbar-sections/{bs_id}/bays            # Создание ячейки
PUT    /api/v1/bays/{bay_id}                          # Обновление ячейки
DELETE /api/v1/bays/{bay_id}                           # Удаление ячейки
```

### Оборудование

```
GET    /api/v1/bays/{bay_id}/equipment                 # Список оборудования ячейки
GET    /api/v1/substations/{id}/equipment             # Все оборудование подстанции
POST   /api/v1/bays/{bay_id}/equipment                 # Добавление оборудования
PUT    /api/v1/equipment/{eq_id}                       # Обновление оборудования
DELETE /api/v1/equipment/{eq_id}                       # Удаление оборудования
```

## Frontend архитектура

### Структура модулей

```
substations/
├── substations.module.ts
├── substations-routing.module.ts
│
├── substations-list/                    # Список подстанций
│   └── substations-list.component.*
│
├── substation-detail/                   # Детальный просмотр подстанции
│   ├── substation-detail.component.*
│   └── substation-info-tab/            # Вкладка "Основная информация"
│
├── substation-structure/                # Иерархическая структура
│   ├── substation-structure.component.*
│   ├── switchyard-node/                # Компонент узла РУ
│   ├── busbar-section-node/            # Компонент узла секции
│   ├── bay-node/                       # Компонент узла ячейки
│   └── equipment-node/                 # Компонент узла оборудования
│
├── structure-editor/                   # Редактор структуры
│   ├── structure-editor.component.*
│   ├── switchyard-form/                # Форма создания/редактирования РУ
│   ├── busbar-section-form/            # Форма секции шин
│   ├── bay-form/                       # Форма ячейки
│   └── equipment-form/                 # Форма оборудования
│
└── services/
    └── substation-structure.service.ts # Сервис для работы со структурой
```

### Компонент иерархической структуры

Основной компонент `SubstationStructureComponent` отображает дерево структуры подстанции с возможностью:
- Раскрытия/сворачивания узлов
- Редактирования элементов через контекстное меню
- Добавления новых элементов
- Удаления элементов
- Перетаскивания элементов (опционально)

### Навигация и доступ

**Вариант 1: Отдельная страница (рекомендуется)**
- Кнопка "Подстанции" в верхней панели инструментов
- Открывает список подстанций
- При клике на подстанцию - переход к детальному просмотру со структурой
- Двойной клик по подстанции на карте также открывает детальный просмотр

**Вариант 2: Модальное окно**
- Двойной клик по подстанции на карте открывает модальное окно с детальной информацией
- В модальном окне вкладки: "Информация", "Структура", "Оборудование"

**Рекомендация: Комбинированный подход**
- Кнопка "Подстанции" в панели → отдельная страница со списком
- Двойной клик на карте → модальное окно с быстрым просмотром
- В модальном окне кнопка "Открыть детально" → переход на отдельную страницу

## UI/UX дизайн

### Страница списка подстанций

```
┌─────────────────────────────────────────────────────────────┐
│  Подстанции                                    [+ Создать]  │
├─────────────────────────────────────────────────────────────┤
│  [Тип: Все ▼] [Регион: Все ▼] [Напряжение: Все ▼] [🔍]    │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 🏭 ТП-123 "Центральная"                    [⋮]       │  │
│  │ 10 кВ | Минск, ул. Ленина, 1                         │  │
│  │ РУ: 2 | Ячейки: 15 | Оборудование: 45 ед.            │  │
│  │ Статус: Активна                                       │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### Страница детального просмотра подстанции

```
┌─────────────────────────────────────────────────────────────┐
│  ← Назад    ТП-123 "Центральная"              [✏️] [🗑️]    │
├─────────────────────────────────────────────────────────────┤
│  [Информация] [Структура] [Оборудование] [Подключения]      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Основная информация                                  │   │
│  │ Тип: ТП | Код: ТП-123 | Напряжение: 10 кВ          │   │
│  │ Адрес: Минск, ул. Ленина, 1                         │   │
│  │ Координаты: 53.9045, 27.5615 [📍 На карте]          │   │
│  │ Статус: Активна                                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Вкладка "Структура" (Иерархическое дерево)

```
┌─────────────────────────────────────────────────────────────┐
│  Структура подстанции                        [+ Добавить РУ] │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  📁 РУ-10 кВ                                    [✏️] [🗑️]   │
│    ├─ 📁 Секция I                              [✏️] [🗑️]   │
│    │   ├─ 📦 Ячейка 1 (Ввод)                   [✏️] [🗑️]   │
│    │   │   ├─ ⚡ Выключатель ВМГ-10            [✏️] [🗑️]   │
│    │   │   └─ 🔌 Разъединитель РЛНД-10        [✏️] [🗑️]   │
│    │   └─ 📦 Ячейка 2 (Отходящая)              [✏️] [🗑️]   │
│    │       └─ ⚡ Выключатель ВМГ-10            [✏️] [🗑️]   │
│    └─ 📁 Секция II                             [✏️] [🗑️]   │
│        └─ 📦 Ячейка 3 (Секционный)              [✏️] [🗑️]   │
│                                                              │
│  📁 РУ-0.4 кВ                                    [✏️] [🗑️] │
│    └─ 📁 Секция I                              [✏️] [🗑️]   │
│        └─ 📦 Ячейки распределения               [✏️] [🗑️]   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Вкладка "Оборудование" (Табличный вид)

```
┌─────────────────────────────────────────────────────────────┐
│  Оборудование (45 ед.)                      [+ Добавить]   │
├─────────────────────────────────────────────────────────────┤
│  [Все типы ▼] [Статус: Все ▼] [РУ: Все ▼] [Поиск...]       │
├─────────────────────────────────────────────────────────────┤
│  РУ-10 кВ / Секция I / Ячейка 1                            │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ ⚡ Выключатель ВМГ-10                        [✏️]   │   │
│  │ ABB | ВМГ-10 | SN-12345                             │   │
│  │ Статус: Активен | Установлен: 01.01.2020            │   │
│  │ Следующее ТО: 01.07.2024                            │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 🔌 Разъединитель РЛНД-10                     [✏️]   │   │
│  │ Siemens | РЛНД-10 | SN-67890                          │   │
│  │ Статус: Активен                                       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## Интеграция с картой

### Отображение подстанций на карте

Подстанции отображаются на карте в виде маркеров большего размера или двойных кружков для визуального отличия от опор. При клике на маркер подстанции открывается popup с краткой информацией и кнопкой "Детально", при двойном клике - сразу открывается детальный просмотр.

### Синхронизация с картой

- При открытии детального просмотра подстанции из списка - карта автоматически центрируется на координатах подстанции
- В детальном просмотре кнопка "Показать на карте" центрирует карту на подстанции
- Изменение координат подстанции обновляет её положение на карте

## Унификация учета: ЛЭП и Подстанции

### Общая концепция учета

Система обеспечивает единообразный подход к учету объектов:

**Для ЛЭП:**
- ЛЭП → Сегменты → Опоры → Оборудование на опорах

**Для Подстанций:**
- Подстанция → РУ → Секции шин → Ячейки → Оборудование

### Общие принципы

1. **Иерархическая структура** - оба типа объектов имеют многоуровневую иерархию
2. **Единый формат оборудования** - оборудование на опорах и в подстанциях использует схожие поля
3. **Единый интерфейс** - похожий UI для работы с деревом объектов
4. **Геопривязка** - все объекты имеют координаты и отображаются на карте
5. **Уникальные идентификаторы** - все объекты имеют mRID по стандарту IEC 61970

## Преимущества предложенной архитектуры

1. **Масштабируемость** - легко добавлять новые уровни иерархии
2. **Гибкость** - JSON поле specifications позволяет хранить различные характеристики оборудования
3. **Стандартизация** - использование mRID соответствует отраслевым стандартам
4. **Удобство навигации** - иерархическое дерево интуитивно понятно
5. **Полнота учета** - охватывает все уровни от подстанции до конкретного оборудования
6. **Интеграция** - легко интегрируется с существующей системой учета ЛЭП

## Рекомендации по реализации

### Этап 1: Backend модели и API
1. Создать модели Switchyard, BusbarSection, Bay, SubstationEquipment
2. Обновить модель Substation (добавить связь с switchyards)
3. Создать Pydantic схемы для всех моделей
4. Реализовать API endpoints для CRUD операций
5. Создать миграцию базы данных

### Этап 2: Frontend структура
1. Создать модуль substations с компонентами
2. Реализовать компонент иерархического дерева
3. Создать формы для создания/редактирования элементов
4. Интегрировать с картой (двойной клик, popup)

### Этап 3: Интеграция и тестирование
1. Протестировать создание полной структуры подстанции
2. Проверить отображение на карте
3. Протестировать синхронизацию данных
4. Оптимизировать производительность

## Альтернативные варианты доступа

### Вариант A: Отдельная страница (рекомендуется)
- Преимущества: больше места для детальной информации, лучше для сложных структур
- Недостатки: уход с карты

### Вариант B: Боковая панель (как для ЛЭП)
- Преимущества: остается видимость карты
- Недостатки: ограниченное пространство для сложной структуры

### Вариант C: Модальное окно с вкладками
- Преимущества: быстрый доступ, не покидая карту
- Недостатки: ограниченный размер, сложнее для глубокой иерархии

**Рекомендация:** Комбинированный подход - модальное окно для быстрого просмотра с кнопкой "Открыть детально" для перехода на отдельную страницу с полной структурой.
