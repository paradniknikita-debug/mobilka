events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Логирование
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    # Настройки производительности
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;
    types_hash_max_size 2048;

    # Определение мобильных устройств по User-Agent
    # Приоритет: сначала проверяем мобильные, потом десктоп
    map $http_user_agent $is_mobile {
        default 0;
        
        # Смартфоны Android (исключаем планшеты)
        ~*android.*mobile.*chrome 1;
        ~*android.*mobile.*firefox 1;
        ~*android.*mobile.*safari 1;
        ~*android.*mobile 1;
        
        # iPhone (смартфоны)
        ~*iphone.*mobile 1;
        ~*iphone 1;
        
        # iPod
        ~*ipod 1;
        
        # Windows Phone/Mobile
        ~*windows.*phone 1;
        ~*windows.*mobile 1;
        ~*iemobile 1;
        
        # BlackBerry
        ~*blackberry 1;
        ~*bb10 1;
        ~*rim.*tablet 0;  # BlackBerry планшеты считаем десктопом
        
        # Opera Mobile/Mini (мобильные версии)
        ~*opera.*mini 1;
        ~*opera.*mobi 1;
        ~*opr/.*mobile 1;
        
        # Firefox Mobile
        ~*fennec 1;
        ~*firefox.*mobile 1;
        
        # Другие мобильные браузеры
        ~*mobile.*safari 1;
        ~*mobile.*chrome 1;
        ~*mobile.*firefox 1;
        
        # Kindle (Fire) - мобильные устройства
        ~*kindle 1;
        ~*silk.*mobile 1;
        
        # Планшеты iPad - считаем мобильными для Flutter
        ~*ipad 1;
        
        # Android планшеты - можно считать мобильными или десктопом
        # По умолчанию считаем мобильными, но можно изменить на 0 если нужен Angular
        ~*android.*tablet 1;
        
        # Исключения: десктопные браузеры (даже если есть слово mobile в UA)
        ~*chrome.*windows 0;
        ~*firefox.*windows 0;
        ~*safari.*macintosh 0;
        ~*edge.*windows 0;
        ~*edg/.*windows 0;
        ~*msie.*windows 0;
        ~*trident.*windows 0;
    }
    
    # Определение пути к корневой директории в зависимости от устройства
    map $is_mobile $web_root {
        default /app/angular-web;
        1 /app/flutter-web;
    }

    # HTTP сервер на порту 4201 (для продакшен-сборки)
    # Маршрутизация:
    # - Мобильные устройства (телефоны, планшеты) → Flutter веб-приложение
    # - Десктоп/Ноутбук → Angular приложение
    # Поддержка доменных имен: lepm.local, mobilka.local, или любой IP
    server {
        listen 4201;
        server_name lepm.local mobilka.local _;
        
        # Логирование для отладки маршрутизации
        access_log /var/log/nginx/access_4201.log main;
        error_log /var/log/nginx/error_4201.log warn;
        
        # Проксирование API запросов к FastAPI (одинаково для всех устройств)
        location /api/ {
            proxy_pass http://backend:8000/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket поддержка
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Таймауты
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Health check endpoint
        location /health {
            proxy_pass http://backend:8000/health;
            proxy_set_header Host $host;
            access_log off;
        }

        # Документация API
        location /docs {
            proxy_pass http://backend:8000/docs;
            proxy_set_header Host $host;
        }

        location /redoc {
            proxy_pass http://backend:8000/redoc;
            proxy_set_header Host $host;
        }

        # Обработка статических файлов с маршрутизацией по устройству
        # Flutter и Angular используют разные пути для статики
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|wasm|json|map)$ {
            root $web_root;
            expires 1y;
            add_header Cache-Control "public, immutable";
            # Пробуем найти файл в определенной директории, если не найден - пробуем Angular
            try_files $uri @fallback_angular;
            # Заголовки для отладки
            add_header X-Served-From $web_root always;
            add_header X-Is-Mobile $is_mobile always;
        }
        
        # Fallback для статических файлов Angular (если файл не найден в Flutter)
        location @fallback_angular {
            root /app/angular-web;
            try_files $uri =404;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # Основной location - маршрутизация по устройству
        # Мобильные → Flutter (/app/flutter-web)
        # Десктоп → Angular (/app/angular-web)
        location / {
            root $web_root;
            index index.html;
            try_files $uri $uri/ /index.html;
            
            # Заголовки для отладки (можно убрать в продакшене)
            add_header X-Served-From $web_root always;
            add_header X-Is-Mobile $is_mobile always;
            add_header X-User-Agent $http_user_agent always;
            
            # Заголовки безопасности
            add_header X-Frame-Options SAMEORIGIN;
            add_header X-Content-Type-Options nosniff;
        }
    }

    # HTTP сервер - порт 80
    # Редирект на HTTPS для продакшена
    # Поддержка доменных имен: lepm.local, mobilka.local, или любой IP
    server {
        listen 80;
        server_name lepm.local mobilka.local _;
        
        # Редирект всех HTTP запросов на HTTPS
        return 301 https://$host$request_uri;
    }

    # HTTPS сервер
    # Поддержка доменных имен: lepm.local, mobilka.local, localhost, или любой IP
    server {
        listen 443 ssl;
        http2 on;
        server_name lepm.local mobilka.local localhost _;
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;
        location /api/ {
            proxy_pass http://backend:8000/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # WebSocket поддержка
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            # Таймауты
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Health check endpoint
        location /health {
            proxy_pass http://backend:8000/health;
            proxy_set_header Host $host;
            access_log off;
        }

        # Документация API (если нужно)
        location /docs {
            proxy_pass http://backend:8000/docs;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /redoc {
            proxy_pass http://backend:8000/redoc;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # OpenAPI JSON для Swagger UI (должен быть ДО блока статических файлов)
        location = /openapi.json {
            proxy_pass http://backend:8000/openapi.json;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Favicon (специальная обработка)
        location = /favicon.ico {
            root $web_root;
            try_files /favicon.ico @fallback_favicon;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        location @fallback_favicon {
            root /app/angular-web;
            try_files /favicon.ico =404;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # Обработка статических файлов с маршрутизацией по устройству
        # Исключаем /openapi.json из этого блока
        location ~* \.(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot|wasm|map)$ {
            root $web_root;
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri @fallback_angular;
        }
        
        # Fallback для статических файлов Angular
        location @fallback_angular {
            root /app/angular-web;
            try_files $uri =404;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # Основной location - маршрутизация по устройству
        # Все остальные запросы (включая /login, /map и т.д.) обрабатываются Angular Router
        location / {
            root $web_root;
            index index.html;
            try_files $uri $uri/ /index.html;
            
            # Заголовки безопасности
            add_header X-Frame-Options SAMEORIGIN;
            add_header X-Content-Type-Options nosniff;
        }
    }
}

