<div class="sidebar-container">
  <div class="sidebar-header">
    <mat-icon class="header-icon">electrical_services</mat-icon>
    <h2>Объекты</h2>
    <p>Дерево объектов на карте</p>
  </div>

  <div class="sidebar-content" *ngIf="!isLoading">
    <div *ngFor="let item of getPowerLinesWithSegmentsAndPoles()" class="tree-item">
      <!-- ЛЭП -->
      <div class="tree-node power-line-node" 
           (click)="togglePowerLine(item.powerLine.properties['id'])"
           [class.expanded]="isPowerLineExpanded(item.powerLine.properties['id'])">
        <mat-icon class="expand-icon">{{ isPowerLineExpanded(item.powerLine.properties['id']) ? 'expand_more' : 'chevron_right' }}</mat-icon>
        <mat-icon class="node-icon" style="color: red;">electrical_services</mat-icon>
        <span class="node-label" (click)="onFeatureClick(item.powerLine, $event)" (contextmenu)="onFeatureRightClick(item.powerLine, $event)">{{ item.powerLine.properties['name'] || 'Без названия' }}</span>
        <span class="node-description">{{ item.powerLine.properties['voltage_level'] }} кВ</span>
      </div>
      
      <!-- Вложенные элементы ЛЭП -->
      <div *ngIf="isPowerLineExpanded(item.powerLine.properties['id'])" class="tree-children">
        <!-- Участки линии (AClineSegment) -->
        <div *ngFor="let segment of item.segments" class="tree-node segment-node">
          <div class="tree-node-header" 
               (click)="toggleSegment(item.powerLine.properties['id'], segment.segmentId)"
               [class.expanded]="isSegmentExpanded(item.powerLine.properties['id'], segment.segmentId)">
            <mat-icon class="expand-icon">{{ isSegmentExpanded(item.powerLine.properties['id'], segment.segmentId) ? 'expand_more' : 'chevron_right' }}</mat-icon>
            <mat-icon class="node-icon" style="color: orange;">timeline</mat-icon>
            <span class="node-label">{{ segment.segmentName || 'Участок ' + segment.segmentId }}</span>
            <span class="node-description">{{ segment.poles.length }} опор</span>
          </div>
          
          <!-- Вложенные элементы участка -->
          <div *ngIf="isSegmentExpanded(item.powerLine.properties['id'], segment.segmentId)" class="tree-children">
            <!-- Папка "Опоры" внутри участка -->
            <div *ngIf="segment.poles.length > 0" class="poles-folder-wrapper">
              <div class="tree-node-header poles-folder-header"
                   (click)="togglePolesFolder(item.powerLine.properties['id'], 'segment-' + segment.segmentId)"
                   [class.expanded]="isPolesFolderExpanded(item.powerLine.properties['id'], 'segment-' + segment.segmentId)">
                <mat-icon class="expand-icon">{{ isPolesFolderExpanded(item.powerLine.properties['id'], 'segment-' + segment.segmentId) ? 'expand_more' : 'chevron_right' }}</mat-icon>
                <mat-icon class="node-icon" style="color: blue;">folder</mat-icon>
                <span class="node-label">Опоры ({{ segment.poles.length }})</span>
              </div>
              
              <!-- Список опор -->
              <div *ngIf="isPolesFolderExpanded(item.powerLine.properties['id'], 'segment-' + segment.segmentId)" class="tree-children poles-list">
                <div *ngFor="let pole of segment.poles" 
                     class="tree-node pole-node"
                     (click)="onFeatureClick(pole, $event)"
                     (contextmenu)="onFeatureRightClick(pole, $event)">
                  <mat-icon class="node-icon" style="color: blue;">account_tree</mat-icon>
                  <span class="node-label">{{ pole.properties['pole_number'] || 'N/A' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Папка "Опоры" для опор без сегмента -->
        <div *ngIf="item.polesWithoutSegment.length > 0" class="poles-folder-wrapper">
          <div class="tree-node-header poles-folder-header"
               (click)="togglePolesFolder(item.powerLine.properties['id'], 'no-segment')"
               [class.expanded]="isPolesFolderExpanded(item.powerLine.properties['id'], 'no-segment')">
            <mat-icon class="expand-icon">{{ isPolesFolderExpanded(item.powerLine.properties['id'], 'no-segment') ? 'expand_more' : 'chevron_right' }}</mat-icon>
            <mat-icon class="node-icon" style="color: blue;">folder</mat-icon>
            <span class="node-label">Опоры ({{ item.polesWithoutSegment.length }})</span>
          </div>
          
          <!-- Список опор -->
          <div *ngIf="isPolesFolderExpanded(item.powerLine.properties['id'], 'no-segment')" class="tree-children poles-list">
            <div *ngFor="let pole of item.polesWithoutSegment" 
                 class="tree-node pole-node"
                 (click)="onFeatureClick(pole, $event)"
                 (contextmenu)="onFeatureRightClick(pole, $event)">
              <mat-icon class="node-icon" style="color: blue;">account_tree</mat-icon>
              <span class="node-label">{{ pole.properties['pole_number'] || 'N/A' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
</div>

